<!DOCTYPE html>
<html lang="en" data-theme="dark">
    <head>
        <meta charset="utf-8" />
        <title>RedFetcher – Yesterday’s Top Reddit Posts</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link
            rel="icon"
            href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%2275%22 font-size=%2275%22 fill=%22%23fff%22>R</text></svg>"
        />
        <link rel="manifest" href="manifest.json" />

        <!-- Font Awesome – integrity removed to avoid hash‑mismatch -->
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        />

        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Montserrat:wght@700&display=swap"
            rel="stylesheet"
        />

        <style>
            :root {
                --bg: #000000;
                --surface: #111111;
                --border: #2a2a2a;
                --accent: #ff0000;
                --text-primary: #e0e0e0;
                --text-secondary: #777777;
                --link-visited: #ff5e5e;
            }

            /* ---------- GENERAL ---------- */
            *,
            *::before,
            *::after {
                box-sizing: border-box;
            }
            html,
            body {
                height: 100%;
                margin: 0;
            }
            body {
                font-family: "Inter", system-ui, sans-serif;
                background: var(--bg);
                color: var(--text-primary);
                display: flex;
                flex-direction: column;
            }
            a {
                color: var(--accent);
                text-decoration: none;
            }
            a:hover,
            a:focus {
                text-decoration: underline;
            }
            a:visited {
                color: var(--link-visited);
            }
            button,
            select,
            input {
                font: inherit;
            }

            /* ---------- HEADER ---------- */
            header {
                background: var(--accent);
                color: #fff;
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0.8rem 1.5rem;
            }
            header h1 {
                margin: 0;
                font-family: "Montserrat", system-ui, sans-serif;
                font-size: 1.8rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            header h1 svg {
                width: 36px;
                height: 36px;
            }

            /* ---------- HAMBURGER ---------- */
            #sidebarToggle {
                background: var(--bg);
                color: var(--accent);
                border: none;
                border-radius: 6px;
                width: 38px;
                height: 38px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
                transition: background 0.2s, color 0.2s;
            }
            #sidebarToggle:hover {
                background: var(--surface);
            }
            #sidebarToggle i {
                transition: transform 0.3s ease;
            }
            #sidebarToggle.open i {
                transform: rotate(90deg);
            }

            /* ---------- LAYOUT ---------- */
            .wrapper {
                flex: 1;
                display: flex;
                overflow: hidden;
            }

            /* ---------- SIDEBAR ---------- */
            .sidebar {
                width: 340px;
                max-width: 100%;
                background: var(--surface);
                border-right: 1px solid var(--border);
                overflow-y: auto;
                flex-shrink: 0;
                display: flex;
                flex-direction: column;
                transition: width 0.35s ease, opacity 0.35s ease,
                    visibility 0.35s;
                visibility: visible;
                opacity: 1;
            }
            .sidebar.collapsed {
                width: 0;
                opacity: 0;
                visibility: hidden;
            }
            @media (max-width: 720px) {
                .wrapper {
                    flex-direction: column;
                }
                .sidebar {
                    width: 100%;
                    max-height: 400px;
                    transition: max-height 0.35s ease, opacity 0.35s ease,
                        visibility 0.35s;
                }
                .sidebar.collapsed {
                    max-height: 0;
                    opacity: 0;
                    visibility: hidden;
                }
            }

            /* ---------- MAIN ---------- */
            .main {
                flex: 1;
                background: var(--surface);
                overflow: auto;
                display: flex;
                flex-direction: column;
            }

            /* ---------- CONTROLS ---------- */
            .controls {
                padding: 1rem;
                display: grid;
                gap: 0.8rem;
                grid-template-columns: 1fr;
            }
            .controls select,
            .controls input[type="search"] {
                padding: 0.5rem 0.8rem;
                border: none;
                border-radius: 8px;
                background: #000;
                color: var(--accent);
                transition: background 0.2s;
            }
            .controls select:focus,
            .controls input:focus {
                outline: 2px solid var(--accent);
            }
            .controls select:hover,
            .controls input:hover {
                background: #1a1a1a;
            }

            .controls button,
            #bookmarks button {
                background: #000;
                color: var(--accent);
                border: 2px solid var(--accent);
                border-radius: 8px;
                padding: 0.5rem 0.8rem;
                cursor: pointer;
                transition: background 0.2s, color 0.2s, transform 0.1s;
            }
            .controls button:hover,
            #bookmarks button:hover {
                background: var(--accent);
                color: #000;
            }
            .controls button:active,
            #bookmarks button:active {
                transform: translateY(2px);
            }
            .controls button[disabled] {
                opacity: 0.5;
                cursor: not-allowed;
            }

            /* ---------- STATUS ---------- */
            #status {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                font-size: 0.9rem;
                color: var(--text-secondary);
                padding: 0 1rem;
            }
            #status.hidden {
                display: none;
            }
            .spinner {
                border: 3px solid #444;
                border-top: 3px solid var(--accent);
                border-radius: 50%;
                width: 1rem;
                height: 1rem;
                animation: spin 0.8s linear infinite;
            }
            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }

            /* ---------- POSTS LIST ---------- */
            #postsHeading {
                margin: 1rem;
                font-size: 1.4rem;
                color: var(--accent);
            }
            #posts {
                flex: 1;
                padding: 0 1rem 1rem;
                display: flex;
                flex-direction: column;
                gap: 0.6rem;
            }

            /* ---------- CARD (shared) ---------- */
            .post-card {
                background: var(--bg);
                border-left: 4px solid var(--accent);
                border-radius: 8px;
                padding: 0.8rem;
                display: flex;
                flex-direction: column;
                gap: 0.3rem;
                transition: background 0.2s;
            }
            .post-card:hover {
                background: #1a1a1a;
            }

            .main .post-card {
                width: 100%;
                max-width: 800px;
                margin: 0 auto;
            }
            .sidebar-content .post-card {
                margin: 0 0.5rem;
            }

            .post-card a.title {
                font-weight: 500;
                color: var(--accent);
            }

            .meta {
                font-size: 0.85rem;
                color: var(--text-secondary);
                display: flex;
                flex-wrap: wrap;
                gap: 0.8rem;
                align-items: center;
            }
            .meta i {
                margin-right: 0.2rem;
            }

            .saveBtn {
                background: none;
                border: none;
                color: var(--accent);
                cursor: pointer;
                font-size: 1.1rem;
                transition: transform 0.2s, color 0.2s;
                align-self: flex-end;
            }
            .saveBtn:hover {
                transform: scale(1.2);
                color: #fff;
            }
            .saveBtn:active {
                transform: scale(0.9);
            }

            /* ---------- BOOKMARKS SECTION ---------- */
            #bookmarks {
                padding: 0 1rem 1rem;
            }
            #bookmarks h2 {
                margin: 0 0 0.5rem 0.5rem;
                font-size: 1.2rem;
                color: var(--accent);
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            #bookmarks button {
                margin-left: auto;
            }

            /* ---------- FOOTER ---------- */
            footer {
                background: var(--surface);
                color: var(--text-secondary);
                text-align: center;
                padding: 0.8rem 1rem;
                font-size: 0.9rem;
                border-top: 1px solid var(--border);
            }

            /* ---------- RESPONSIVE ---------- */
            @media (max-width: 720px) {
                .main .post-card {
                    max-width: 100%;
                    margin: 0;
                }
            }
            @media (max-width: 440px) {
                .sidebar {
                    display: none;
                }
            }

            /* ---------- HR ABOVE BOOKMARKS ---------- */
            .sidebar hr {
                width: 90%;
                margin: 1rem auto;
                border: none;
                border-top: 1px solid var(--border);
            }
        </style>
    </head>
    <body>
        <header>
            <h1 aria-label="RedFetcher">
                <svg viewBox="0 0 100 100" aria-hidden="true" focusable="false">
                    <circle cx="50" cy="50" r="45" fill="var(--accent)" />
                    <path
                        d="M35 30 h20 a15 15 0 0 1 0 30 h-20 Z"
                        fill="var(--bg)"
                    />
                    <line
                        x1="50"
                        y1="30"
                        x2="50"
                        y2="70"
                        stroke="var(--accent)"
                        stroke-width="6"
                    />
                </svg>
                RedFetcher
            </h1>
            <button id="sidebarToggle" aria-label="Toggle sidebar">
                <i class="fa-solid fa-bars"></i>
            </button>
        </header>

        <div class="wrapper">
            <!-- ==================== SIDEBAR ==================== -->
            <aside class="sidebar" id="sidebar">
                <section class="controls" aria-label="Controls">
                    <select id="topicSelect" aria-label="Select topic">
                        <option value="" disabled selected>
                            Choose a topic…
                        </option>
                    </select>

                    <input
                        type="search"
                        id="searchInput"
                        placeholder="Search titles…"
                        aria-label="Search posts"
                    />

                    <select id="sortSelect" aria-label="Sort posts">
                        <option value="score">Score ↓</option>
                        <option value="comments">Comments ↓</option>
                        <option value="newest">Newest</option>
                        <option value="oldest">Oldest</option>
                    </select>

                    <button id="refreshBtn" disabled>Refresh</button>
                </section>

                <hr />

                <section
                    class="sidebar-content"
                    id="bookmarks"
                    aria-label="Saved posts"
                >
                    <h2>
                        Saved Posts
                        <button id="clearBookmarksBtn" title="Clear bookmarks">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </h2>
                    <div id="bookmarkList" role="list"></div>
                </section>
            </aside>

            <!-- ==================== MAIN ==================== -->
            <main class="main main-content" aria-label="Content">
                <h2 id="postsHeading">Yesterday’s Top Posts</h2>

                <div id="status" class="hidden" aria-live="polite">
                    <div class="spinner"></div>
                    <span>Loading…</span>
                </div>

                <section
                    id="posts"
                    role="list"
                    aria-label="Reddit posts"
                ></section>

                <footer>
                    Made with ❤️ by
                    <a
                        href="https://github.com/yourname"
                        target="_blank"
                        rel="noopener"
                        style="color: var(--accent); text-decoration: none"
                    >
                        Your Name
                    </a>
                    – © 2024
                </footer>
            </main>
        </div>

        <script>
            /* ====================== CONFIG ====================== */
            const TOPIC_MAP = {
                "Web Design": [
                    "webdev",
                    "frontend",
                    "css",
                    "javascript",
                    "reactjs",
                    "UXDesign",
                    "userexperience",
                    "web_design",
                    "learnwebdev",
                    "learnjavascript",
                ],
                Programming: [
                    "learnprogramming",
                    "programming",
                    "javascript",
                    "python",
                    "learnjavascript",
                    "learnpython",
                    "AskProgramming",
                    "coding",
                    "codinghelp",
                ],
                "Self Hosting": [
                    "selfhosted",
                    "opensource",
                    "docker",
                    "homelab",
                    "proxmox",
                    "linuxadmin",
                    "nextcloud",
                    "homeserver",
                    "homenetworking",
                    "sysadmin",
                ],
                "Artificial Intelligence": [
                    "LocalLLM",
                    "learnmachinelearning",
                    "MachineLearning",
                    "GPT3",
                    "Automate",
                    "PromptDesign",
                    "artificial",
                    "LocalLLaMA",
                    "AI_Agents",
                ],
                "Desktop Customisation": [
                    "unixporn",
                    "Rainmeter",
                    "kde",
                    "gnome",
                    "desktops",
                    "windowscustomization",
                    "Windows_Redesign",
                ],
                "Phone Customisation": [
                    "Kustom",
                    "androidthemes",
                    "homescreens",
                    "android",
                    "OneUiHomescreens",
                ],
            };
            const MAX_PER_SUB = 25;
            const STORAGE_PREFIX = "redfetcher";

            /* ====================== HELPERS ====================== */
            const getYesterdayUTC = () => {
                const now = new Date();
                const todayStart = Date.UTC(
                    now.getUTCFullYear(),
                    now.getUTCMonth(),
                    now.getUTCDate()
                );
                const start = todayStart - 86400_000; // 24 h back
                const end = todayStart - 1;
                return [Math.floor(start / 1000), Math.floor(end / 1000)];
            };
            const storageKey = (topic, date) =>
                `${STORAGE_PREFIX}_${topic}_${date}`;

            /* ====================== UI REFS ====================== */
            const topicSelect = document.getElementById("topicSelect");
            const refreshBtn = document.getElementById("refreshBtn");
            const statusEl = document.getElementById("status");
            const postsEl = document.getElementById("posts");
            const searchInput = document.getElementById("searchInput");
            const sortSelect = document.getElementById("sortSelect");
            const clearBookmarksBtn =
                document.getElementById("clearBookmarksBtn");
            const bookmarkList = document.getElementById("bookmarkList");
            const sidebarToggle = document.getElementById("sidebarToggle");
            const sidebarEl = document.getElementById("sidebar");

            /* ====================== POPULATE TOPIC SELECT ====================== */
            Object.keys(TOPIC_MAP).forEach((t) => {
                const opt = document.createElement("option");
                opt.value = t;
                opt.textContent = t;
                topicSelect.appendChild(opt);
            });

            /* ====================== SERVICE WORKER ====================== */
            if ("serviceWorker" in navigator) {
                navigator.serviceWorker
                    .register("sw.js")
                    .catch((e) => console.warn("SW registration failed:", e));
            }

            /* ====================== FETCH LOGIC ====================== */
            async function fetchSubreddit(sub) {
                const url = `https://www.reddit.com/r/${sub}/top/.json?t=day&limit=${MAX_PER_SUB}`;
                const resp = await fetch(url);
                if (!resp.ok) throw new Error(`r/${sub} error`);
                const data = await resp.json();
                return data.data.children.map((c) => c.data);
            }
            function filterYesterday(posts) {
                const [start, end] = getYesterdayUTC();
                return posts.filter(
                    (p) => p.created_utc >= start && p.created_utc <= end
                );
            }
            async function loadTopic(topic, forceRefresh = false) {
                const [start] = getYesterdayUTC();
                const dateStr = new Date(start * 1000)
                    .toISOString()
                    .slice(0, 10);
                const cacheKey = storageKey(topic, dateStr);
                const cached = localStorage.getItem(cacheKey);
                if (cached && !forceRefresh) {
                    renderPosts(JSON.parse(cached));
                    refreshBtn.disabled = false;
                    return;
                }

                showStatus(true);
                refreshBtn.disabled = true;
                try {
                    const subs = TOPIC_MAP[topic];
                    const all = [];
                    const BATCH = 5;
                    for (let i = 0; i < subs.length; i += BATCH) {
                        const batch = subs
                            .slice(i, i + BATCH)
                            .map(fetchSubreddit);
                        const results = await Promise.allSettled(batch);
                        results.forEach((r) => {
                            if (r.status === "fulfilled") {
                                const filtered = filterYesterday(r.value);
                                filtered.forEach((p) =>
                                    all.push({
                                        title: p.title,
                                        url: `https://www.reddit.com${p.permalink}`,
                                        subreddit: p.subreddit,
                                        score: p.score,
                                        comments: p.num_comments,
                                        created_utc: p.created_utc,
                                    })
                                );
                            }
                        });
                        await new Promise((res) => setTimeout(res, 200));
                    }
                    localStorage.setItem(cacheKey, JSON.stringify(all));
                    renderPosts(all);
                } catch (e) {
                    postsEl.innerHTML = `<p style="color:#ff6666;">${e.message}</p>`;
                } finally {
                    showStatus(false);
                    refreshBtn.disabled = false;
                }
            }

            /* ====================== STATUS ====================== */
            function showStatus(show) {
                statusEl.classList.toggle("hidden", !show);
            }

            /* ====================== RENDERING ====================== */
            let currentPosts = [];

            function renderPosts(posts) {
                currentPosts = posts;
                applyFiltersAndSort();
            }

            function applyFiltersAndSort() {
                const term = searchInput.value.trim().toLowerCase();
                const sort = sortSelect.value;

                let filtered = currentPosts.filter((p) =>
                    p.title.toLowerCase().includes(term)
                );

                filtered.sort((a, b) => {
                    if (sort === "score") return b.score - a.score;
                    if (sort === "comments") return b.comments - a.comments;
                    if (sort === "newest") return b.created_utc - a.created_utc;
                    if (sort === "oldest") return a.created_utc - b.created_utc;
                    return 0;
                });

                postsEl.innerHTML = "";
                if (!filtered.length) {
                    postsEl.innerHTML =
                        '<p style="color:var(--text-secondary);padding:1rem;">No posts match your query.</p>';
                    return;
                }

                const frag = document.createDocumentFragment();
                filtered.forEach((p) => {
                    const card = document.createElement("article");
                    card.className = "post-card";
                    card.setAttribute("role", "listitem");

                    const title = document.createElement("a");
                    title.href = p.url;
                    title.target = "_blank";
                    title.rel = "noopener";
                    title.className = "title";
                    title.textContent = p.title;

                    const saveBtn = document.createElement("button");
                    saveBtn.className = "saveBtn";
                    saveBtn.title = "Save";
                    saveBtn.innerHTML = "★";
                    saveBtn.addEventListener("click", (e) => {
                        e.stopPropagation();
                        toggleBookmark(p);
                    });

                    const meta = document.createElement("div");
                    meta.className = "meta";
                    meta.innerHTML = `
      <span><i class="fa-solid fa-reddit-alien"></i>r/${p.subreddit}</span>
      <span><i class="fa-solid fa-arrow-up"></i>${p.score}</span>
      <span><i class="fa-solid fa-comment"></i>${p.comments}</span>
    `;

                    card.append(title, saveBtn, meta);
                    frag.appendChild(card);
                });
                postsEl.appendChild(frag);
            }

            /* ====================== BOOKMARKS ====================== */
            function getSaved() {
                const raw = localStorage.getItem(`${STORAGE_PREFIX}_bookmarks`);
                return raw ? JSON.parse(raw) : [];
            }
            function saveBookmarks(arr) {
                localStorage.setItem(
                    `${STORAGE_PREFIX}_bookmarks`,
                    JSON.stringify(arr)
                );
            }
            function toggleBookmark(post) {
                const saved = getSaved();
                const idx = saved.findIndex((p) => p.url === post.url);
                if (idx > -1) saved.splice(idx, 1);
                else saved.push(post);
                saveBookmarks(saved);
                renderBookmarks();
            }
            function renderBookmarks() {
                const saved = getSaved();
                bookmarkList.innerHTML = "";
                if (!saved.length) {
                    bookmarkList.innerHTML =
                        '<p style="color:var(--text-secondary);padding:0.5rem;">No saved posts.</p>';
                    return;
                }
                const frag = document.createDocumentFragment();
                saved.forEach((p) => {
                    const card = document.createElement("article");
                    card.className = "post-card";
                    card.setAttribute("role", "listitem");

                    const a = document.createElement("a");
                    a.href = p.url;
                    a.target = "_blank";
                    a.rel = "noopener";
                    a.className = "title";
                    a.textContent = p.title;

                    const delBtn = document.createElement("button");
                    delBtn.className = "saveBtn";
                    delBtn.title = "Remove";
                    delBtn.innerHTML = "✕";
                    delBtn.addEventListener("click", () => toggleBookmark(p));

                    const meta = document.createElement("div");
                    meta.className = "meta";
                    meta.innerHTML = `
      <span><i class="fa-solid fa-reddit-alien"></i>r/${p.subreddit}</span>
      <span><i class="fa-solid fa-arrow-up"></i>${p.score}</span>
      <span><i class="fa-solid fa-comment"></i>${p.comments}</span>
    `;

                    card.append(a, delBtn, meta);
                    frag.appendChild(card);
                });
                bookmarkList.appendChild(frag);
            }

            /* ====================== EVENT LISTENERS ====================== */
            topicSelect.addEventListener("change", () => {
                const t = topicSelect.value;
                if (t) {
                    loadTopic(t);
                    refreshBtn.disabled = false;
                }
            });
            refreshBtn.addEventListener("click", () =>
                loadTopic(topicSelect.value, true)
            );
            searchInput.addEventListener("input", applyFiltersAndSort);
            sortSelect.addEventListener("change", applyFiltersAndSort);

            clearBookmarksBtn.addEventListener("click", () => {
                if (confirm("Delete all saved bookmarks?")) {
                    localStorage.removeItem(`${STORAGE_PREFIX}_bookmarks`);
                    renderBookmarks();
                }
            });

            sidebarToggle.addEventListener("click", () => {
                sidebarEl.classList.toggle("collapsed");
                sidebarToggle.classList.toggle("open");
            });

            /* ====================== INITIAL STATE ====================== */
            renderBookmarks(); // bookmarks always visible
        </script>
    </body>
</html>
